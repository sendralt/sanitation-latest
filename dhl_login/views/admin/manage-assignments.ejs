<style>
      .assignments-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
      }
      .assignments-table th,
      .assignments-table td {
        padding: 0.75rem;
        text-align: left;
        border-bottom: 1px solid #ddd;
      }
      .assignments-table th {
        background-color: #f8f9fa;
        font-weight: bold;
      }
      .status-badge {
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.875rem;
        font-weight: bold;
        text-transform: uppercase;
      }
      .status-assigned { background-color: #007bff; color: white; }
      .status-completed { background-color: #28a745; color: white; }
      .status-cancelled { background-color: #6c757d; color: white; }
      .status-overdue { background-color: #dc3545; color: white; }
      .status-validated { background-color: #17a2b8; color: white; }
      .filters-section {
        background-color: #f8f9fa;
        padding: 1rem;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
      }
      .filter-row {
        display: flex;
        gap: 1rem;
        align-items: end;
        flex-wrap: wrap;
      }
      .filter-group {
        display: flex;
        flex-direction: column;
        min-width: 150px;
      }
      .assignment-type {
        font-size: 0.875rem;
        color: #6c757d;
        text-transform: uppercase;
      }
      .manual-assignment {
        color: #dc3545;
        font-weight: bold;
      }
      .auto-assignment {
        color: #28a745;
      }
    </style>

<div class="page-container" style="max-width: none; width: fit-content; min-width: 1000px;">
  <header class="page-header">
    <h1>Assignments Status</h1>
  </header>

  <% if (locals.errorMessages && errorMessages.length > 0) { %>
    <div class="flash-message error" role="alert">
      <% errorMessages.forEach(function(message) { %>
        <p class="mb-0"><%- message %></p>
      <% }); %>
    </div>
  <% } %>
  <% if (locals.successMessages && successMessages.length > 0) { %>
    <div class="flash-message success" role="alert">
      <% successMessages.forEach(function(message) { %>
        <p class="mb-0"><%- message %></p>
      <% }); %>
    </div>
  <% } %>

  <!-- Filters Section -->
  <div class="filters-section">
    <h3>Filter Assignments</h3>
    <form method="GET" action="/admin/assignments/manage">
      <div class="filter-row">
        <div class="filter-group">
          <label for="status" class="form-label">Status</label>
          <select id="status" name="status" class="form-control">
            <option value="all" <%= filters.status === 'all' ? 'selected' : '' %>>All Statuses</option>
            <option value="assigned" <%= filters.status === 'assigned' ? 'selected' : '' %>>Assigned</option>
            <option value="completed" <%= filters.status === 'completed' ? 'selected' : '' %>>Submitted</option>
            <option value="cancelled" <%= filters.status === 'cancelled' ? 'selected' : '' %>>Cancelled</option>
            <option value="overdue" <%= filters.status === 'overdue' ? 'selected' : '' %>>Overdue</option>
            <option value="validated" <%= filters.status === 'validated' ? 'selected' : '' %>>Validated</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label for="userId" class="form-label">User</label>
          <select id="userId" name="userId" class="form-control">
            <option value="all" <%= filters.userId === 'all' ? 'selected' : '' %>>All Users</option>
            <% users.forEach(function(u) { %>
              <option value="<%= u.id %>" <%= filters.userId === u.id ? 'selected' : '' %>>
                <%= u.firstName %> <%= u.lastName %>
              </option>
            <% }); %>
          </select>
        </div>
        
        <div class="filter-group">
          <label for="search" class="form-label">Search</label>
          <input type="text" id="search" name="search" class="form-control"
                 placeholder="Search users or checklists..." value="<%= filters.search %>">
        </div>

        <div class="filter-group">
          <label for="dateFrom" class="form-label">Date From</label>
          <input type="date" id="dateFrom" name="dateFrom" class="form-control"
                 value="<%= filters.dateFrom %>">
        </div>

        <div class="filter-group">
          <label for="dateTo" class="form-label">Date To</label>
          <input type="date" id="dateTo" name="dateTo" class="form-control"
                 value="<%= filters.dateTo %>">
        </div>

        <div class="filter-group">
          <div style="display: flex; gap: 0.75rem; margin-top: 0.5rem; justify-content: center; align-items: center;">
            <button type="submit" class="btn btn-primary">Apply Filters</button>
            <a href="/admin/assignments/manage" class="btn btn-secondary">Clear</a>
          </div>
        </div>
      </div>
    </form>
  </div>
 
  <!-- Assignments Table -->
  <div class="table-responsive">
    <% if (assignments.length === 0) { %>
      <div class="alert alert-info">
        <h4>No assignments found</h4>
        <p>No assignments match your current filters. Try adjusting your search criteria or <a href="/admin/assignments/assign">create a new assignment</a>.</p>
      </div>
    <% } else { %>
      <table class="assignments-table">
        <thead>
          <tr>
            <th>User</th>
            <th>Checklist</th>
            <th>Type</th>
            <th>Status</th>
            <th>Assigned</th>
            <th>Assignment Type</th>
            <th>Submitted</th>
            <th>Validated</th>
          </tr>
        </thead>
        <tbody>
          <% assignments.forEach(function(assignment) { %>
            <tr>
              <td>
                <strong><%= assignment.user.firstName %> <%= assignment.user.lastName %></strong><br>
                <small class="text-muted">@<%= assignment.user.username %></small>
              </td>
              <td>
                <strong><%= assignment.checklist.title %></strong><br>
                <small class="text-muted"><%= assignment.checklist.filename %></small>
              </td>
              <td>
                <span class="assignment-type">
                  <%= assignment.checklist.type %>
                </span>
              </td>
              <td>
                <span class="status-badge status-<%= assignment.status %>">
                  <%= assignment.status %>
                </span>
              </td>
              <td>
                <%= new Date(assignment.assignedAt).toLocaleDateString() %><br>
                <small class="text-muted"><%= new Date(assignment.assignedAt).toLocaleTimeString() %></small>
              </td>
              <td>
                <% if (assignment.assignedBy) { %>
                  <span class="manual-assignment">Manual</span><br>
                  <small class="text-muted">by <%= assignment.assignedBy.firstName %> <%= assignment.assignedBy.lastName %></small>
                <% } else { %>
                  <span class="auto-assignment">Automatic</span>
                <% } %>
              </td>
              <td>
                <% if (assignment.completedAt) { %>
                  <%= new Date(assignment.completedAt).toLocaleDateString() %><br>
                  <small class="text-muted"><%= new Date(assignment.completedAt).toLocaleTimeString() %></small>
                <% } else { %>
                  <span class="text-muted">Not completed</span>
                <% } %>
              </td>
              <td>
                <% if (assignment.status === 'validated' && assignment.validatedAt) { %>
                  <%= new Date(assignment.validatedAt).toLocaleDateString() %><br>
                  <small class="text-muted"><%= new Date(assignment.validatedAt).toLocaleTimeString() %></small>
                  <% if (assignment.validator) { %>
                    <br><small class="text-muted">by <%= assignment.validator.firstName %> <%= assignment.validator.lastName %></small>
                  <% } %>
                <% } else if (assignment.status === 'validated') { %>
                  <span class="text-success">Validated</span>
                <% } else { %>
                  <span class="text-muted">Not validated</span>
                <% } %>
              </td>
            </tr>
          <% }); %>
        </tbody>
      </table>
    <% } %>
  </div>

  <!-- Summary Statistics -->
  <div class="info-section" style="margin-top: 2rem;">
    <h3>Assignment Statistics</h3>
    <div class="row">
      <div class="col">
        <strong>Total Assignments:</strong> <%= assignments.length %>
      </div>
      <div class="col">
        <strong>Active:</strong> <%= assignments.filter(a => a.status === 'assigned').length %>
      </div>
      <div class="col">
        <strong>Submitted:</strong> <%= assignments.filter(a => a.status === 'completed').length %>
      </div>
      <div class="col">
        <strong>Cancelled:</strong> <%= assignments.filter(a => a.status === 'cancelled').length %>
      </div>
      <div class="col">
        <strong>Validated:</strong> <%= assignments.filter(a => a.status === 'validated').length %>
      </div>
      <div class="form-actions">
        <button type="submit" class="btn btn-primary">Assign Checklist</button>
        <a href="/dashboard" class="btn btn-primary">Back to Dashboard</a>
      </div>
    </div>
  </div>
</div>
