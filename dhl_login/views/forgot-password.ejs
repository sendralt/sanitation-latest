<div class="page-container">
  <header class="page-header">
    <h1><%= title %></h1>
  </header>

  <!-- Flash Messages -->
  <% if (locals.errorMessages && errorMessages.length > 0) { %>
    <div class="flash-message error" role="alert">
      <% errorMessages.forEach(function(message) { %>
        <p class="mb-0"><%- message %></p>
      <% }); %>
    </div>
  <% } %>
  
  <% if (locals.successMessages && successMessages.length > 0) { %>
    <div class="flash-message success" role="alert">
      <% successMessages.forEach(function(message) { %>
        <p class="mb-0"><%- message %></p>
      <% }); %>
    </div>
  <% } %>

  <% if (step === 1) { %>
    <!-- Step 1: Enter Username -->
    <div class="forgot-password-step">
      <p class="step-description">Enter your username to begin the password reset process.</p>
      
      <form action="/forgot-password" method="POST" autocomplete="off">
        <input type="hidden" name="_csrf" value="<%- _csrf %>">
        
        <div class="form-group">
          <label for="username">Username</label>
          <input type="text" id="username" name="username" value="<%= username %>" required autocomplete="off" class="form-control">
        </div>

        <button type="submit" class="btn btn-primary">Continue</button>
      </form>
      
      <div class="form-footer">
        <a href="/login-page" class="btn btn-secondary btn-inline">Back to Login</a>
      </div>
    </div>

  <% } else if (step === 2) { %>
    <!-- Step 2: Security Questions -->
    <div class="forgot-password-step">
      <p class="step-description">Please answer your security questions to verify your identity.</p>
      <p class="username-display"><strong>Username:</strong> <%= username %></p>
      
      <form action="/forgot-password/verify-answers" method="POST" autocomplete="off">
        <input type="hidden" name="_csrf" value="<%- _csrf %>">
        <input type="hidden" name="questionId1" value="<%= questions[0].id %>">
        <input type="hidden" name="questionId2" value="<%= questions[1].id %>">

        <div class="form-group">
          <label for="answer1"><%= questions[0].text %></label>
          <input type="text" id="answer1" name="answer1" required autocomplete="off" class="form-control">
        </div>

        <div class="form-group">
          <label for="answer2"><%= questions[1].text %></label>
          <input type="text" id="answer2" name="answer2" required autocomplete="off" class="form-control">
        </div>

        <button type="submit" class="btn btn-primary">Verify Answers</button>
      </form>
      
      <div class="form-footer">
        <a href="/forgot-password" class="btn btn-secondary btn-inline">Start Over</a>
        <a href="/login-page" class="btn btn-secondary btn-inline">Back to Login</a>
      </div>
    </div>

  <% } else if (step === 3) { %>
    <!-- Step 3: Reset Password -->
    <div class="forgot-password-step">
      <p class="step-description">Security questions verified! Enter your new password.</p>
      <p class="username-display"><strong>Username:</strong> <%= username %></p>
      
      <form action="/forgot-password/reset" method="POST" autocomplete="off">
        <input type="hidden" name="_csrf" value="<%- _csrf %>">
        
        <div class="form-group">
          <label for="newPassword">New Password</label>
          <input type="password" id="newPassword" name="newPassword" required autocomplete="new-password" class="form-control" minlength="8">
          <small class="form-text">Password must be at least 8 characters long.</small>
        </div>

        <div class="form-group">
          <label for="confirmPassword">Confirm New Password</label>
          <input type="password" id="confirmPassword" name="confirmPassword" required autocomplete="new-password" class="form-control" minlength="8">
        </div>

        <button type="submit" class="btn btn-primary">Reset Password</button>
      </form>
      
      <div class="form-footer">
        <a href="/login-page" class="btn btn-secondary btn-inline">Back to Login</a>
      </div>
    </div>

  <% } %>

  <div class="footer" style="text-align: center; margin-top: 25px; font-size: 14px; color: #666;">
    &copy; 2025 DHL Supply Chain | Warehouse Sanitation Checklists
  </div>
</div>

<script>
// Client-side password confirmation validation
document.addEventListener('DOMContentLoaded', function() {
  const newPasswordField = document.getElementById('newPassword');
  const confirmPasswordField = document.getElementById('confirmPassword');
  
  if (newPasswordField && confirmPasswordField) {
    function validatePasswords() {
      const newPassword = newPasswordField.value;
      const confirmPassword = confirmPasswordField.value;
      
      if (confirmPassword && newPassword !== confirmPassword) {
        confirmPasswordField.setCustomValidity('Passwords do not match');
      } else {
        confirmPasswordField.setCustomValidity('');
      }
    }
    
    newPasswordField.addEventListener('input', validatePasswords);
    confirmPasswordField.addEventListener('input', validatePasswords);
  }
});
</script>
